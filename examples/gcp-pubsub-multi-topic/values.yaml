# HyperFleet GCP + Pub/Sub Multi-Topic Deployment Example
#
# This example deploys the full HyperFleet stack with multi-topic support:
# - HyperFleet API
# - Sentinel (clusters) + Sentinel (nodepools)
# - Landing Zone Adapter (clusters)
# - Validation-GCP Adapter (clusters) + Validation-GCP Adapter (nodepools)
#
# Prerequisites:
# 1. GKE cluster with Workload Identity enabled
# 2. Pub/Sub topics and subscriptions created (use hyperfleet-infra terraform)
# 3. GCP service accounts with appropriate IAM bindings
#
# Usage:
#   cd charts/hyperfleet-gcp
#   helm dependency update
#   helm install hyperfleet . -f ../../examples/gcp-pubsub-multi-topic/values.yaml \
#     -n hyperfleet-system --create-namespace
#
# Replace all <PLACEHOLDER> values with your actual configuration.
# You can generate these values from terraform output:
#   terraform output -json pubsub_config

base:
  global:
    image:
      registry: "<YOUR_REGISTRY>"  # e.g., "quay.io/your-org"

    hyperfleetApi:
      baseUrl: "http://hyperfleet-hyperfleet-api:8000"
      version: "v1"

    broker:
      type: googlepubsub
      googlepubsub:
        enabled: true
        projectId: "<GCP_PROJECT_ID>"
      rabbitmq:
        enabled: false

  hyperfleet-api:
    enabled: true
    replicaCount: 1
    image:
      registry: "<YOUR_REGISTRY>"
      repository: hyperfleet-api
      tag: "<API_IMAGE_TAG>"  # e.g., "v1.0.0" or "dev-abc1234"
    database:
      postgresql:
        enabled: true
        password: "<DB_PASSWORD>"  # Change in production!

  # ==========================================================================
  # Sentinel for CLUSTERS topic
  # ==========================================================================
  sentinel:
    enabled: true
    replicaCount: 1
    image:
      registry: "<YOUR_REGISTRY>"
      repository: sentinel
      tag: "<SENTINEL_IMAGE_TAG>"
    serviceAccount:
      create: true
      name: sentinel
      annotations:
        iam.gke.io/gcp-service-account: "<SENTINEL_GCP_SA>"  # e.g., sentinel@project.iam.gserviceaccount.com
    config:
      resourceType: clusters
      pollInterval: 5s
    broker:
      type: googlepubsub
      topic: "<CLUSTERS_TOPIC>"  # e.g., "hyperfleet-system-clusters"
      googlepubsub:
        projectId: "<GCP_PROJECT_ID>"

  # ==========================================================================
  # Sentinel for NODEPOOLS topic
  # ==========================================================================
  sentinel-nodepools:
    enabled: true
    replicaCount: 1
    image:
      registry: "<YOUR_REGISTRY>"
      repository: sentinel
      tag: "<SENTINEL_IMAGE_TAG>"
    serviceAccount:
      create: true
      name: sentinel-nodepools
      annotations:
        # Same GCP SA - has publish access to all topics
        iam.gke.io/gcp-service-account: "<SENTINEL_GCP_SA>"
    config:
      resourceType: nodepools
      pollInterval: 5s
    broker:
      type: googlepubsub
      topic: "<NODEPOOLS_TOPIC>"  # e.g., "hyperfleet-system-nodepools"
      googlepubsub:
        projectId: "<GCP_PROJECT_ID>"

  # ==========================================================================
  # Landing Zone Adapter (clusters only)
  # ==========================================================================
  adapter-landing-zone:
    enabled: true
    replicaCount: 1
    image:
      registry: "<YOUR_REGISTRY>"
      repository: hyperfleet-adapter
      tag: "<ADAPTER_IMAGE_TAG>"
    serviceAccount:
      create: true
      name: landing-zone-adapter
      annotations:
        iam.gke.io/gcp-service-account: "<LANDING_ZONE_GCP_SA>"
    hyperfleetApi:
      baseUrl: "http://hyperfleet-hyperfleet-api:8000"
      version: "v1"
    broker:
      type: googlepubsub
      googlepubsub:
        projectId: "<GCP_PROJECT_ID>"
        topic: "<CLUSTERS_TOPIC>"
        subscription: "<LANDING_ZONE_SUBSCRIPTION>"  # e.g., "hyperfleet-system-clusters-landing-zone-adapter"
        deadLetterTopic: "<CLUSTERS_DLQ_TOPIC>"
      subscriber:
        parallelism: 1

  rabbitmq:
    enabled: false

# =============================================================================
# Validation-GCP Adapter for CLUSTERS topic
# =============================================================================
validation-gcp:
  enabled: true
  replicaCount: 1
  deploymentMode: "dummy"  # Use "real" when validation-gcp-adapter.yaml exists
  image:
    registry: "<YOUR_REGISTRY>"
    repository: hyperfleet-adapter
    tag: "<ADAPTER_IMAGE_TAG>"
  serviceAccount:
    create: true
    name: validation-gcp-adapter
    annotations:
      iam.gke.io/gcp-service-account: "<VALIDATION_GCP_SA>"
  hyperfleetApi:
    baseUrl: "http://hyperfleet-hyperfleet-api:8000"
    version: "v1"
  broker:
    type: googlepubsub
    googlepubsub:
      projectId: "<GCP_PROJECT_ID>"
      topic: "<CLUSTERS_TOPIC>"
      subscription: "<VALIDATION_GCP_CLUSTERS_SUBSCRIPTION>"
      deadLetterTopic: "<CLUSTERS_DLQ_TOPIC>"
    subscriber:
      parallelism: 1

# =============================================================================
# Validation-GCP Adapter for NODEPOOLS topic
# =============================================================================
validation-gcp-nodepools:
  enabled: true
  replicaCount: 1
  deploymentMode: "dummy"
  image:
    registry: "<YOUR_REGISTRY>"
    repository: hyperfleet-adapter
    tag: "<ADAPTER_IMAGE_TAG>"
  serviceAccount:
    create: true
    name: validation-gcp-nodepools-adapter
    annotations:
      # Same GCP SA - has subscribe access to all its subscriptions
      iam.gke.io/gcp-service-account: "<VALIDATION_GCP_SA>"
  hyperfleetApi:
    baseUrl: "http://hyperfleet-hyperfleet-api:8000"
    version: "v1"
  broker:
    type: googlepubsub
    googlepubsub:
      projectId: "<GCP_PROJECT_ID>"
      topic: "<NODEPOOLS_TOPIC>"
      subscription: "<VALIDATION_GCP_NODEPOOLS_SUBSCRIPTION>"
      deadLetterTopic: "<NODEPOOLS_DLQ_TOPIC>"
    subscriber:
      parallelism: 1
